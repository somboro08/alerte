{% extends "base.html" %}

{% block title %}{{ signalement.title }} - SignalAlert{% endblock %}

{% block head_extra %}
<style>
/* Variables CSS supplémentaires */
:root {
    --card-shadow-hover: 0 10px 30px rgba(0, 0, 0, 0.1);
    --transition-smooth: all 0.3s ease;
}

/* Conteneur principal */
.signalement-detail {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--spacing-xl) var(--spacing-md);
}

/* Header amélioré */
.signalement-header {
    margin-bottom: var(--spacing-xxl);
    position: relative;
}

.back-nav {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: var(--gray-color);
    text-decoration: none;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--border-radius);
    transition: var(--transition-smooth);
    margin-bottom: var(--spacing-lg);
    background: var(--white);
    box-shadow: var(--shadow-sm);
}

.back-nav:hover {
    color: var(--primary-color);
    background: var(--primary-light);
    transform: translateX(-5px);
}

.header-top {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

@media (min-width: 768px) {
    .header-top {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
    }
}

.title-section {
    flex: 1;
}

.signalement-title {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: var(--spacing-sm);
    color: var(--dark-color);
}

@media (max-width: 768px) {
    .signalement-title {
        font-size: 1.8rem;
    }
}

.badge-container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-md);
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-lost { background: var(--secondary-color); color: white; }
.badge-missing { background: #e74c3c; color: white; }
.badge-theft { background: #f39c12; color: white; }
.badge-found { background: #2ecc71; color: white; }
.badge-active { background: var(--primary-color); color: white; }

/* Image principale */
.image-container {
    position: relative;
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow-lg);
    transition: var(--transition-smooth);
}

.image-container:hover {
    transform: translateY(-5px);
    box-shadow: var(--card-shadow-hover);
}

.signalement-image {
    width: 100%;
    height: 400px;
    object-fit: cover;
    display: block;
}

.image-placeholder {
    height: 400px;
    background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-color);
}

.image-placeholder i {
    font-size: 4rem;
    margin-bottom: var(--spacing-md);
}

/* Grid d'informations améliorée */
.signalement-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

@media (max-width: 576px) {
    .signalement-info-grid {
        grid-template-columns: 1fr;
    }
}

.info-card {
    background: var(--white);
    padding: var(--spacing-lg);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
    transition: var(--transition-smooth);
    border: 1px solid var(--gray-light);
    position: relative;
    overflow: hidden;
}

.info-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--card-shadow-hover);
}

.info-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--primary-color);
}

.info-card h4 {
    color: var(--gray-color);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: var(--spacing-sm);
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}

.info-card h4 i {
    color: var(--primary-color);
    width: 20px;
}

.info-card p {
    font-size: 1.1rem;
    font-weight: 500;
    margin: 0;
    color: var(--dark-color);
}

/* Section description */
.signalement-content {
    background: var(--white);
    padding: var(--spacing-xl);
    border-radius: var(--border-radius-lg);
    margin-bottom: var(--spacing-xl);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-light);
}

.signalement-content h2 {
    font-size: 1.5rem;
    margin-bottom: var(--spacing-lg);
    color: var(--dark-color);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--primary-light);
}

.description-text {
    white-space: pre-line;
    line-height: 1.8;
    font-size: 1.1rem;
    color: var(--gray-dark);
}

/* Section contact */
.contact-section {
    background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
    padding: var(--spacing-xl);
    border-radius: var(--border-radius-lg);
    margin-bottom: var(--spacing-xl);
    position: relative;
    overflow: hidden;
}

.contact-section::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: var(--primary-color);
    opacity: 0.1;
    border-radius: 50%;
    transform: translate(50px, -50px);
}

.contact-section h3 {
    font-size: 1.3rem;
    margin-bottom: var(--spacing-md);
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.contact-info {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    align-items: center;
}

.contact-details {
    flex: 1;
    min-width: 250px;
}

.contact-name {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 1.2rem;
    margin-bottom: var(--spacing-xs);
}

.contact-method {
    color: var(--gray-dark);
    font-size: 1rem;
}

.contact-actions {
    display: flex;
    gap: var(--spacing-sm);
}

.contact-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--white);
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
    border-radius: var(--border-radius);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition-smooth);
}

.contact-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

/* Section partage */
.share-section {
    background: var(--white);
    padding: var(--spacing-xl);
    border-radius: var(--border-radius-lg);
    margin-bottom: var(--spacing-xl);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-light);
}

.share-section h3 {
    font-size: 1.3rem;
    margin-bottom: var(--spacing-md);
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.qr-code-container {
    text-align: center;
    margin: var(--spacing-lg) 0;
}

.qr-code {
    width: 150px;
    height: 150px;
    border: 1px solid var(--gray-light);
    padding: var(--spacing-sm);
    border-radius: var(--border-radius);
    background: white;
    box-shadow: var(--shadow-sm);
    transition: var(--transition-smooth);
}

.qr-code:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
}

.share-link-group {
    margin-bottom: var(--spacing-lg);
}

.share-link-input {
    position: relative;
    display: flex;
    gap: var(--spacing-sm);
}

@media (max-width: 576px) {
    .share-link-input {
        flex-direction: column;
    }
}

.share-link-input .form-control {
    flex: 1;
}

.copy-btn {
    white-space: nowrap;
}

.social-share {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    justify-content: center;
    margin-top: var(--spacing-lg);
}

.social-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--border-radius);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition-smooth);
    min-width: 120px;
    justify-content: center;
}

.social-btn.facebook { 
    background: #3b5998; 
    color: white;
    border: 2px solid #3b5998;
}

.social-btn.twitter { 
    background: #1DA1F2; 
    color: white;
    border: 2px solid #1DA1F2;
}

.social-btn.whatsapp { 
    background: #25D366; 
    color: white;
    border: 2px solid #25D366;
}

.social-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    opacity: 0.9;
}

/* Actions principales */
.signalement-actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin: var(--spacing-xl) 0;
    padding: var(--spacing-lg);
    background: var(--white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
}

.action-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--border-radius);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition-smooth);
    min-width: 140px;
    justify-content: center;
}

@media (max-width: 576px) {
    .action-btn {
        min-width: 100%;
    }
}

/* Formulaire de contact */
.contact-form {
    background: var(--white);
    padding: var(--spacing-xl);
    border-radius: var(--border-radius-lg);
    margin-top: var(--spacing-xl);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--gray-light);
    display: none;
    animation: slideDown 0.3s ease;
}

.contact-form.active {
    display: block;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
}

.form-header h3 {
    margin: 0;
    color: var(--dark-color);
}

.close-form {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--gray-color);
    cursor: pointer;
    padding: var(--spacing-xs);
    transition: var(--transition-smooth);
}

.close-form:hover {
    color: var(--primary-color);
    transform: rotate(90deg);
}

/* Utilitaires */
.divider {
    height: 1px;
    background: var(--gray-light);
    margin: var(--spacing-xl) 0;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--gray-light);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Badge animé */
.badge-pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Animation pour les éléments au scroll */
.animate-in {
    animation: fadeInUp 0.6s ease forwards;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container signalement-detail">
    <!-- Navigation retour -->
    <a href="{{ url_for('signalements') }}" class="back-nav">
        <i class="fas fa-arrow-left"></i> Retour aux signalements
    </a>

    <!-- Header -->
    <div class="signalement-header">
        <div class="header-top">
            <div class="title-section">
                <h1 class="signalement-title">{{ signalement.title }}</h1>
                <div class="badge-container">
                    <span class="status-badge badge-{{ signalement.type }}">
                        {% if signalement.type == 'lost' %}
                            <i class="fas fa-search"></i> Objet perdu
                        {% elif signalement.type == 'missing' %}
                            <i class="fas fa-user-missing"></i> Personne disparue
                        {% else %}
                            <i class="fas fa-shield-alt"></i> Objet volé
                        {% endif %}
                    </span>
                    
                    {% if signalement.status == 'found' %}
                    <span class="status-badge badge-found badge-pulse">
                        <i class="fas fa-check-circle"></i> Retrouvé
                    </span>
                    {% else %}
                    <span class="status-badge badge-active">
                        <i class="fas fa-circle"></i> Actif
                    </span>
                    {% endif %}
                    
                    {% if signalement.reward %}
                    <span class="status-badge" style="background: #f39c12; color: white;">
                        <i class="fas fa-gift"></i> Récompense
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="metadata">
                <div style="color: var(--gray-color); font-size: 0.9rem;">
                    <i class="far fa-clock"></i> Publié le {{ signalement.created_at.strftime('%d/%m/%Y à %H:%M') }}
                </div>
                <div style="color: var(--gray-color); font-size: 0.9rem; margin-top: var(--spacing-xs);">
                    <i class="fas fa-eye"></i> {{ signalement.views or 0 }} vues
                </div>
            </div>
        </div>
        
        <!-- Image principale -->
        <div class="image-container">
            {% if signalement.image_url %}
            <img src="/static/uploads/images/{{ signalement.image_url }}" 
                 alt="{{ signalement.title }}" 
                 class="signalement-image"
                 loading="lazy">
            {% else %}
            <div class="image-placeholder">
                <div style="text-align: center;">
                    <i class="fas fa-camera"></i>
                    <p>Aucune image disponible</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Grid d'informations -->
    <div class="signalement-info-grid">
        <div class="info-card">
            <h4><i class="fas fa-map-marker-alt"></i> Localisation</h4>
            <p>{{ signalement.location }}</p>
            {% if signalement.lat and signalement.lng %}
            <small style="color: var(--gray-color); margin-top: var(--spacing-xs); display: block;">
                <i class="fas fa-crosshairs"></i> Coordonnées GPS disponibles
            </small>
            {% endif %}
        </div>
        
        <div class="info-card">
            <h4><i class="far fa-calendar-alt"></i> Date</h4>
            <p>{{ signalement.date.strftime('%A %d %B %Y') }}</p>
            {% set days_ago = (now.date() - signalement.date.date()).days %}
            <small style="color: var(--gray-color); margin-top: var(--spacing-xs); display: block;">
                Il y a {{ days_ago }} jour{% if days_ago > 1 %}s{% endif %}
            </small>
        </div>
        
        <div class="info-card">
            <h4><i class="fas fa-tags"></i> Catégorie</h4>
            <p>{{ signalement.category or 'Non spécifié' }}</p>
        </div>
        
        <div class="info-card">
            <h4><i class="fas fa-user-circle"></i> Auteur</h4>
            <p>{{ signalement.author.username }}</p>
            <small style="color: var(--gray-color); margin-top: var(--spacing-xs); display: block;">
                <i class="fas fa-star"></i> {{ signalement.author.signalements|length }} signalements
            </small>
        </div>
        
        {% if signalement.reward %}
        <div class="info-card">
            <h4><i class="fas fa-award"></i> Récompense</h4>
            <p style="color: #f39c12; font-weight: bold;">{{ signalement.reward }}</p>
        </div>
        {% endif %}
        
        <div class="info-card">
            <h4><i class="fas fa-info-circle"></i> Identification</h4>
            <p>{{ signalement.identification or 'Non spécifié' }}</p>
        </div>
    </div>
    
    <!-- Description détaillée -->
    <div class="signalement-content">
        <h2><i class="fas fa-align-left"></i> Description détaillée</h2>
        <div class="description-text">
            {{ signalement.description }}
        </div>
        
        {% if signalement.additional_info %}
        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--gray-lightest); border-radius: var(--border-radius);">
            <h4 style="color: var(--gray-color); margin-bottom: var(--spacing-sm);">
                <i class="fas fa-sticky-note"></i> Informations supplémentaires
            </h4>
            <p>{{ signalement.additional_info }}</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Section contact -->
    <div class="contact-section">
        <h3><i class="fas fa-address-card"></i> Contact</h3>
        <div class="contact-info">
            <div class="contact-details">
                <div class="contact-name">{{ signalement.contact }}</div>
                {% if signalement.phone %}
                <div class="contact-method">
                    <i class="fas fa-phone"></i> {{ signalement.phone }}
                </div>
                {% endif %}
                {% if signalement.email %}
                <div class="contact-method">
                    <i class="fas fa-envelope"></i> {{ signalement.email }}
                </div>
                {% endif %}
            </div>
            <div class="contact-actions">
                {% if signalement.phone %}
                <a href="tel:{{ signalement.phone }}" class="contact-btn">
                    <i class="fas fa-phone"></i> Appeler
                </a>
                {% endif %}
                <button class="contact-btn" id="contactBtn">
                    <i class="fas fa-envelope"></i> Message
                </button>
            </div>
        </div>
    </div>
    
    <!-- Section partage -->
    <div class="share-section">
        <h3><i class="fas fa-share-alt"></i> Partager ce signalement</h3>
        <p style="color: var(--gray-color); margin-bottom: var(--spacing-lg);">
            Aidez à diffuser l'information en partageant ce signalement sur vos réseaux.
        </p>
        
        <div class="qr-code-container">
            {% if signalement.qr_code_url %}
            <img src="/static/{{ signalement.qr_code_url }}" 
                 alt="QR Code du signalement" 
                 class="qr-code">
            <p style="color: var(--gray-color); margin-top: var(--spacing-sm); font-size: 0.9rem;">
                Scannez pour accéder au signalement
            </p>
            {% else %}
            <div style="padding: var(--spacing-xl); background: var(--gray-lightest); border-radius: var(--border-radius);">
                <i class="fas fa-qrcode" style="font-size: 3rem; color: var(--gray-color);"></i>
                <p>QR Code en génération...</p>
            </div>
            {% endif %}
        </div>
        
        <div class="share-link-group">
            <label class="form-label">Lien du signalement :</label>
            <div class="share-link-input">
                <input type="text" 
                       id="shareLink" 
                       class="form-control" 
                       value="{{ url_for('signalement_detail', id=signalement.id, _external=True) }}" 
                       readonly>
                <button class="btn btn-primary copy-btn" id="copyBtn">
                    <i class="fas fa-copy"></i> Copier
                </button>
            </div>
        </div>
        
        <div class="social-share">
            <a href="https://www.facebook.com/sharer/sharer.php?u={{ url_for('signalement_detail', id=signalement.id, _external=True) }}" 
               target="_blank" 
               class="social-btn facebook">
                <i class="fab fa-facebook-f"></i> Facebook
            </a>
            <a href="https://twitter.com/intent/tweet?url={{ url_for('signalement_detail', id=signalement.id, _external=True) }}&text={{ signalement.title }}" 
               target="_blank" 
               class="social-btn twitter">
                <i class="fab fa-twitter"></i> Twitter
            </a>
            <a href="https://api.whatsapp.com/send?text={{ signalement.title }}%20{{ url_for('signalement_detail', id=signalement.id, _external=True) }}" 
               target="_blank" 
               class="social-btn whatsapp">
                <i class="fab fa-whatsapp"></i> WhatsApp
            </a>
        </div>
    </div>
    
    <!-- Actions principales -->
    <div class="signalement-actions">
        <button class="btn btn-primary action-btn" id="mainContactBtn">
            <i class="fas fa-envelope"></i> Contacter
        </button>
        
        <button class="btn btn-outline action-btn" id="mainShareBtn">
            <i class="fas fa-share-alt"></i> Partager
        </button>

        <a href="{{ url_for('download_signalement_pdf', id=signalement.id) }}" 
           target="_blank" 
           class="btn btn-outline action-btn">
            <i class="fas fa-file-pdf"></i> PDF
        </a>

        <a href="{{ url_for('download_signalement_pdf', id=signalement.id) }}" 
           target="_blank" 
           class="btn btn-outline action-btn">
            <i class="fas fa-print"></i> Imprimer
        </a>
        
        {% if current_user.is_authenticated and current_user.id == signalement.user_id %}
        <a href="{{ url_for('edit_signalement', id=signalement.id) }}" 
           class="btn btn-outline action-btn">
            <i class="fas fa-edit"></i> Modifier
        </a>
        
        {% if signalement.status == 'active' %}
        <button class="btn btn-success action-btn" id="markFoundBtn">
            <i class="fas fa-check-circle"></i> Marquer retrouvé
        </button>
        {% endif %}
        {% endif %}
        
        {% if current_user.is_authenticated and current_user.is_admin %}
        <button class="btn btn-danger action-btn" id="deleteBtn">
            <i class="fas fa-trash"></i> Supprimer
        </button>
        {% endif %}
    </div>
    
    <!-- Formulaire de contact -->
    <div class="contact-form" id="contactForm">
        <div class="form-header">
            <h3><i class="fas fa-paper-plane"></i> Envoyer un message</h3>
            <button class="close-form" id="closeForm">&times;</button>
        </div>
        
        <form id="messageForm">
            <div class="form-group">
                <label class="form-label">Votre message</label>
                <textarea class="form-control" 
                          rows="5" 
                          placeholder="Bonjour, je pense avoir des informations concernant votre signalement..."
                          required></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Vos coordonnées (optionnel)</label>
                <input type="text" 
                       class="form-control" 
                       placeholder="Nom / Téléphone / Email">
            </div>
            
            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                <button type="submit" class="btn btn-primary">
                    <span id="submitText">Envoyer le message</span>
                    <span id="submitLoading" style="display: none;">
                        <span class="loading"></span> Envoi en cours...
                    </span>
                </button>
                <button type="button" class="btn btn-outline" id="cancelBtn">
                    Annuler
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Éléments DOM
    const contactBtn = document.getElementById('contactBtn');
    const mainContactBtn = document.getElementById('mainContactBtn');
    const contactForm = document.getElementById('contactForm');
    const closeForm = document.getElementById('closeForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const shareBtn = document.getElementById('mainShareBtn');
    const copyBtn = document.getElementById('copyBtn');
    const shareLinkInput = document.getElementById('shareLink');
    const markFoundBtn = document.getElementById('markFoundBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const messageForm = document.getElementById('messageForm');
    const submitText = document.getElementById('submitText');
    const submitLoading = document.getElementById('submitLoading');
    
    // Ouvrir formulaire de contact
    function openContactForm() {
        contactForm.classList.add('active');
        document.body.style.overflow = 'hidden';
        window.scrollTo({
            top: contactForm.offsetTop - 100,
            behavior: 'smooth'
        });
    }
    
    // Fermer formulaire de contact
    function closeContactForm() {
        contactForm.classList.remove('active');
        document.body.style.overflow = '';
        messageForm.reset();
    }
    
    // Gestionnaires d'événements pour le formulaire
    if (contactBtn) contactBtn.addEventListener('click', openContactForm);
    if (mainContactBtn) mainContactBtn.addEventListener('click', openContactForm);
    if (closeForm) closeForm.addEventListener('click', closeContactForm);
    if (cancelBtn) cancelBtn.addEventListener('click', closeContactForm);
    
    // Fermer en cliquant en dehors
    document.addEventListener('click', function(e) {
        if (contactForm.classList.contains('active') && 
            !contactForm.contains(e.target) && 
            e.target !== contactBtn && 
            e.target !== mainContactBtn &&
            !contactBtn.contains(e.target) &&
            !mainContactBtn.contains(e.target)) {
            closeContactForm();
        }
    });
    
    // Copier le lien
    if (copyBtn) {
        copyBtn.addEventListener('click', async function() {
            try {
                await navigator.clipboard.writeText(shareLinkInput.value);
                
                // Feedback visuel
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copié !';
                copyBtn.classList.remove('btn-primary');
                copyBtn.classList.add('btn-success');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('btn-success');
                    copyBtn.classList.add('btn-primary');
                }, 2000);
            } catch (err) {
                // Fallback pour les anciens navigateurs
                shareLinkInput.select();
                document.execCommand('copy');
                
                // Feedback visuel
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copié !';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            }
        });
    }
    
    // Partager
    if (shareBtn) {
        shareBtn.addEventListener('click', async function() {
            const shareData = {
                title: '{{ signalement.title }}',
                text: '{{ signalement.description[:100] }}...',
                url: shareLinkInput.value
            };
            
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback: copier le lien
                    await navigator.clipboard.writeText(shareLinkInput.value);
                    alert('Lien copié dans le presse-papier !');
                }
            } catch (err) {
                console.log('Erreur de partage:', err);
            }
        });
    }
    
    // Marquer comme retrouvé
    if (markFoundBtn) {
        markFoundBtn.addEventListener('click', async function() {
            if (confirm('Voulez-vous vraiment marquer ce signalement comme retrouvé ?')) {
                try {
                    const response = await fetch('/api/signalements/{{ signalement.id }}/found', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Erreur lors de la mise à jour');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('Erreur de connexion');
                }
            }
        });
    }
    
    // Supprimer le signalement
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            if (confirm('Voulez-vous vraiment supprimer ce signalement ? Cette action est irréversible.')) {
                fetch('/api/signalements/{{ signalement.id }}', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '{{ url_for("signalements") }}';
                    } else {
                        alert('Erreur lors de la suppression');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur de connexion');
                });
            }
        });
    }
    
    // Envoyer un message
    if (messageForm) {
        messageForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                message: this.querySelector('textarea').value,
                contact: this.querySelector('input[type="text"]').value,
                signalement_id: {{ signalement.id }}
            };
            
            // Afficher l'indicateur de chargement
            submitText.style.display = 'none';
            submitLoading.style.display = 'inline';
            
            try {
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert('Message envoyé avec succès !');
                    closeContactForm();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Erreur lors de l\'envoi du message');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur de connexion');
            } finally {
                // Cacher l'indicateur de chargement
                submitText.style.display = 'inline';
                submitLoading.style.display = 'none';
            }
        });
    }
    
    // Animation au défilement
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-in');
            }
        });
    }, observerOptions);
    
    // Observer les éléments à animer
    document.querySelectorAll('.info-card, .signalement-content, .contact-section, .share-section').forEach(el => {
        observer.observe(el);
    });
    
    // Gérer les dates en JavaScript si nécessaire
    const now = new Date();
    const signalementDate = new Date('{{ signalement.date }}');
    const daysDiff = Math.floor((now - signalementDate) / (1000 * 60 * 60 * 24));
    
    // Mettre à jour le compteur de jours si présent dans le DOM
    const daysAgoElement = document.querySelector('.days-ago');
    if (daysAgoElement) {
        daysAgoElement.textContent = `Il y a ${daysDiff} jour${daysDiff > 1 ? 's' : ''}`;
    }
});
</script>
{% endblock %}