{% extends "base.html" %}

{% block title %}{{ signalement.title }} - SignalAlert{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/signalement_detail.css') }}">
<style>
    .comments-section { margin-top: 30px; }
    .comment-list { list-style-type: none; padding: 0; }
    .comment-item {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .comment-item .comment-author { font-weight: bold; color: #0056b3; }
    .comment-item .comment-date { font-size: 0.85em; color: #6c757d; margin-left: 10px; }
    .comment-item p { margin: 10px 0 0; }
    .comment-form textarea { width: 100%; min-height: 100px; }
</style>
{% endblock %}

{% block content %}
<div class="container signalement-detail-page">
    
    <a href="{{ url_for('signalements') }}" class="back-link">
        <i class="fas fa-arrow-left"></i> Retour aux signalements
    </a>

    <div class="detail-grid">
        <!-- Main Content -->
        <main class="main-content">
            <section class="detail-header">
                <div class="badge-container">
                    <span class="badge badge-type badge-{{ signalement.type }}">
                        {% if signalement.type == 'lost' %}Perdu
                        {% elif signalement.type == 'missing' %}Disparu
                        {% else %}Volé{% endif %}
                    </span>
                    {% if signalement.status == 'found' %}
                    <span class="badge badge-status badge-found">Retrouvé</span>
                    {% endif %}
                </div>
                <h1 class="detail-title">{{ signalement.title }}</h1>
                <div class="meta-info">
                    <span class="meta-item">
                        <i class="fas fa-map-marker-alt"></i> {{ signalement.location }}
                    </span>
                    <span class="meta-item">
                        <i class="far fa-calendar-alt"></i>
                        {% set days_ago = (now.date() - signalement.date.date()).days %}
                        {% if days_ago == 0 %}Aujourd'hui
                        {% elif days_ago == 1 %}Hier
                        {% else %}Il y a {{ days_ago }} jours
                        {% endif %}
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-eye"></i> {{ signalement.views or 0 }} vues
                    </span>
                </div>
            </section>

            <section class="detail-description card">
                <h2><i class="fas fa-align-left"></i> Description</h2>
                <p>{{ signalement.description | nl2br }}</p>
                {% if signalement.additional_info %}
                <div class="additional-info">
                    <h4>Informations supplémentaires</h4>
                    <p>{{ signalement.additional_info }}</p>
                </div>
                {% endif %}
            </section>

            <section class="detail-contact card">
                <h2><i class="fas fa-address-book"></i> Contacter le déclarant</h2>
                <p>Si vous avez des informations, veuillez contacter {{ signalement.author.username }}.</p>
                <div class="contact-methods">
                    {% if signalement.phone %}
                    <a href="tel:{{ signalement.phone }}" class="btn btn-secondary">
                        <i class="fas fa-phone"></i> Appeler
                    </a>
                    {% endif %}
                    <a href="mailto:{{ signalement.email }}" class="btn btn-secondary">
                        <i class="fas fa-envelope"></i> Envoyer un email
                    </a>
                </div>
            </section>

            {% if current_user.is_authenticated and current_user.id == signalement.user_id and signalement.status == 'active' %}
            <section class="card action-card">
                <div class="card-header">
                    <h2>Action du Propriétaire</h2>
                </div>
                <div class="card-body">
                    <p>Votre signalement est toujours actif. Si votre objet a été retrouvé, marquez-le comme tel.</p>
                    <form action="{{ url_for('api_mark_as_found', id=signalement.id) }}" method="POST" onsubmit="return confirm('Êtes-vous sûr de vouloir marquer ce signalement comme RETROUVÉ ? Cette action est irréversible.');">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check-circle"></i> Marquer comme Retrouvé
                        </button>
                    </form>
                </div>
            </section>
            {% endif %}

            <section class="comments-section card">
                <h2><i class="fas fa-comments"></i> Commentaires ({{ comments|length }})</h2>
                
                {% if current_user.is_authenticated %}
                <div class="comment-form">
                    <form action="{{ url_for('add_comment', id=signalement.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="form-group">
                            <label for="comment_content">Laissez un commentaire</label>
                            <textarea name="comment_content" id="comment_content" class="form-control" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Envoyer</button>
                    </form>
                </div>
                {% else %}
                <p>Vous devez être <a href="{{ url_for('login', next=request.path) }}">connecté</a> pour laisser un commentaire.</p>
                {% endif %}

                <hr>

                <div class="comment-list-container">
                    {% if comments %}
                        <ul class="comment-list">
                        {% for comment in comments %}
                            <li class="comment-item">
                                <span class="comment-author">{{ comment.author.username }}</span>
                                <span class="comment-date">
                                    {% set days_ago = (now.date() - comment.timestamp.date()).days %}
                                    {% if days_ago == 0 %}aujourd'hui
                                    {% elif days_ago == 1 %}hier
                                    {% else %}il y a {{ days_ago }} jours
                                    {% endif %}
                                </span>
                                <p>{{ comment.content | nl2br }}</p>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucun commentaire pour le moment.</p>
                    {% endif %}
                </div>
            </section>

        </main>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-sticky">
                <div class="sidebar-card card">
                    <div class="card-image-container">
                        {% if signalement.image_url %}
                        <img src="/static/uploads/images/{{ signalement.image_url }}" alt="{{ signalement.title }}" class="sidebar-image">
                        {% else %}
                        <div class="sidebar-image-placeholder">
                            <i class="fas fa-image"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="sidebar-card card">
                    <h3><i class="fas fa-info-circle"></i> Détails clés</h3>
                    <ul class="key-details-list">
                        <li>
                            <i class="fas fa-user"></i>
                            <strong>Auteur:</strong> {{ signalement.author.username }}
                        </li>
                        <li>
                            <i class="fas fa-tag"></i>
                            <strong>Catégorie:</strong> {{ signalement.category or 'Non spécifié' }}
                        </li>
                        <li>
                            <i class="fas fa-calendar-day"></i>
                            <strong>Date de l'évènement:</strong> {{ signalement.date.strftime('%d %B %Y') }}
                        </li>
                        {% if signalement.reward %}
                        <li>
                            <i class="fas fa-award"></i>
                            <strong>Récompense:</strong> <span class="reward">{{ signalement.reward }}</span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                
                <div class="sidebar-card card">
                    <h3><i class="fas fa-file-pdf"></i> Affiche PDF</h3>
                    <p>Téléchargez une affiche à imprimer et à partager.</p>
                    <a href="{{ url_for('generer_signalement_pdf', id=signalement.id) }}" class="btn btn-primary" target="_blank">
                        <i class="fas fa-download"></i> Télécharger l'affiche
                    </a>
                </div>

                <div class="sidebar-card card">
                    <h3><i class="fas fa-share-alt"></i> Partager</h3>
                    <div class="social-share">
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" target="_blank" class="social-btn facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://twitter.com/intent/tweet?url={{ request.url }}&text={{ signalement.title }}" target="_blank" class="social-btn twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://api.whatsapp.com/send?text={{ signalement.title }} {{ request.url }}" target="_blank" class="social-btn whatsapp"><i class="fab fa-whatsapp"></i></a>
                        <a href="mailto:?subject={{ signalement.title }}&body={{ request.url }}" class="social-btn email"><i class="fas fa-envelope"></i></a>
                    </div>
                    <div class="share-link-group">
                        <input type="text" id="shareLink" class="form-control" value="{{ request.url }}" readonly>
                        <button class="btn btn-primary copy-btn" id="copyBtn"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            </div>
        </aside>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const copyBtn = document.getElementById('copyBtn');
    const shareLinkInput = document.getElementById('shareLink');

    if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(shareLinkInput.value);
                const originalIcon = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = originalIcon;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        });
    }
});
</script>
{% endblock %}